---
title: "Covid plots"
output: html_notebook
---

## Set-up
Load packages and set options
```{r include = F, results = 'hide'}
# load packages
library(data.table)
library(ggplot2)
library(scales)
library(dplyr)
library(lubridate)
library(utils)
library(httr)
library(graphics)

# turn off scientific notation
options(scipen = 999)
```

Read in files from NYT opensource database
```{r include = F, results = 'hide'}
state.raw <- data.table(read.csv(file=url("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv"), header=T))
county.raw <- data.table(read.csv(file=url("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"), header=T))
```

Add useful fields & local files
```{r include = F, results = 'hide'}
# format dates
state.raw[, date := as.Date(date)]
county.raw[, date := as.Date(date)]

# grad stay-at-home dates (manually updated locally)
stay_dates <- fread("~/covid19/stay_at_home_dates.csv")
stay_dates[, start_date := as.Date(start_date, format = "%Y-%m-%d")]
```


## Total counts
Confirmed cases -- US
```{r}
agg.cases.US <- state.raw[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.US.plot <- ggplot(agg.cases.US[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = "United States") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = comma)
agg.cases.US.plot
```

Confirmed cases -- specific state
```{r}
# adjust state name to flow through rest of code (use capitalized full state name)
use.state <- "South Carolina"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.state.plot <- ggplot(agg.cases.state[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = comma)
agg.cases.state.plot
```

Confirmed cases -- specific county
```{r}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "California"
use.county <- "Orange"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = comma)
agg.cases.county.plot
```

Deaths -- US
```{r}
agg.deaths.US <- state.raw[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.US.plot <- ggplot(agg.deaths.US[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = "United States") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = comma)
agg.deaths.US.plot
```

Deaths -- specific state
```{r}
# adjust state name to flow through rest of code (use capitalized full state name)
use.state <- "Washington"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- cases.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.state.plot <- ggplot(agg.deaths.state[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
agg.deaths.state.plot
```

Deaths -- specific county
```{r}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "California"
use.county <- "Orange"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
agg.deaths.county.plot
```

## New counts
Confirmed cases -- US
```{r}
agg.cases.US <- state.raw[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.US
agg.cases.US[, total_cases_prev := temp$total_cases[match(agg.cases.US$date - 1, temp$date)]]
agg.cases.US[, total_new_cases := total_cases - total_cases_prev]
agg.new.cases.US.plot <- ggplot(agg.cases.US[date >= "2020-03-01"], aes(x = date, y = total_new_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = "United States") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = comma)
agg.new.cases.US.plot
```

Confirmed cases -- specific state
```{r}
use.state <- "Washington"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.state
agg.cases.state[, total_cases_prev := temp$total_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_new_cases := total_cases - total_cases_prev]
agg.new.cases.state.plot <- ggplot(agg.cases.state[date >= "2020-03-01"], aes(x = date, y = total_new_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = comma)
agg.new.cases.state.plot
```

Confirmed cases -- specific county
```{r}
use.state <- "Washington"
use.county <- "Pierce"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.county
agg.cases.county[, total_cases_prev := temp$total_cases[match(agg.cases.county$date - 1, temp$date)]]
agg.cases.county[, total_new_cases := total_cases - total_cases_prev]
agg.new.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_new_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = comma)
agg.new.cases.county.plot
```

Deaths -- US
```{r}
agg.deaths.US <- state.raw[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.US
agg.deaths.US[, total_deaths_prev := temp$total_deaths[match(agg.deaths.US$date - 1, temp$date)]]
agg.deaths.US[, total_new_deaths := total_deaths - total_deaths_prev]
agg.new.deaths.US.plot <- ggplot(agg.deaths.US[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = "United States") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = comma)
agg.new.deaths.US.plot
```

Deaths -- specific state
```{r}
use.state <- "Washington"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- deaths.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_prev := temp$total_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_new_deaths := total_deaths - total_deaths_prev]
agg.new.deaths.state.plot <- ggplot(agg.deaths.state[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
agg.new.deaths.state.plot
```

Deaths -- specific county
```{r}
use.state <- "Washington"
use.county <- "Pierce"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.county
agg.deaths.county[, total_deaths_prev := temp$total_deaths[match(agg.deaths.county$date - 1, temp$date)]]
agg.deaths.county[, total_new_deaths := total_deaths - total_deaths_prev]
agg.new.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
agg.new.deaths.county.plot
```

## Rate of growth
Confirmed cases -- US
```{r}
agg.cases.US <- state.raw[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.US
agg.cases.US[, total_cases_prev3 := temp$total_cases[match(agg.cases.US$date - 3, temp$date)]]
agg.cases.US[, total_cases_rtgrowth := total_cases/total_cases_prev3 - 1]
agg.cases.growth.US.plot <- ggplot(agg.cases.US[date >= "2020-03-01"], aes(x = date, y = total_cases_rtgrowth)) + 
  geom_line() +
    labs(x = "Date",
       y = "Rate of growth (rolling 3-day window)",
       title = "Rolling 3-day rate of growth: Total confirmed COVID cases",
       subtitle = "United States") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, max(agg.cases.US$total_cases_rtgrowth * 1.1)))
agg.cases.growth.US.plot
```

Confirmed cases -- specific state
```{r}
use.state <- "Washington"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.state
agg.cases.state[, total_cases_prev3 := temp$total_cases[match(agg.cases.state$date - 3, temp$date)]]
agg.cases.state[, total_cases_rtgrowth := total_cases/total_cases_prev3 - 1]
agg.cases.growth.state.plot <- ggplot(agg.cases.state[date >= "2020-03-01"], aes(x = date, y = total_cases_rtgrowth)) + 
  geom_line() +
    labs(x = "Date",
       y = "Rate of growth (rolling 3-day window)",
       title = "Rolling 3-day rate of growth: Total confirmed COVID cases",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, max(agg.cases.state$total_cases_rtgrowth * 1.1)))
agg.cases.growth.state.plot
```

Confirmed cases -- specific county
```{r}
use.state <- "Washington"
use.county <- "Pierce"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.county
agg.cases.county[, total_cases_prev3 := temp$total_cases[match(agg.cases.county$date - 3, temp$date)]]
agg.cases.county[, total_cases_rtgrowth := total_cases/total_cases_prev3 - 1]
agg.cases.growth.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_cases_rtgrowth)) + 
  geom_line() +
    labs(x = "Date",
       y = "Rate of growth (rolling 3-day window)",
       title = "Rolling 3-day rate of growth: Total confirmed COVID cases",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, max(agg.cases.county$total_cases_rtgrowth * 1.1)))
agg.cases.growth.county.plot
```

Deaths -- US
```{r}
agg.deaths.US <- state.raw[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.US
agg.deaths.US[, total_deaths_prev3 := temp$total_deaths[match(agg.deaths.US$date - 3, temp$date)]]
agg.deaths.US[, total_deaths_rtgrowth := total_deaths/total_deaths_prev3 - 1]
agg.deaths.growth.US.plot <- ggplot(agg.deaths.US[date >= "2020-03-10"], aes(x = date, y = total_deaths_rtgrowth)) + 
  geom_line() +
    labs(x = "Date",
       y = "Rate of growth (rolling 3-day window)",
       title = "Rolling 3-day rate of growth: Total COVID-related deaths",
       subtitle = "United States") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, max(agg.deaths.US$total_deaths_rtgrowth * 1.1)))
agg.deaths.growth.US.plot
```

Deaths -- specific state
```{r}
use.state <- "Washington"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- deaths.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_prev3 := temp$total_deaths[match(agg.deaths.state$date - 3, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth := total_deaths/total_deaths_prev3 - 1]
agg.deaths.growth.state.plot <- ggplot(agg.deaths.state[date >= "2020-03-10"], aes(x = date, y = total_deaths_rtgrowth)) + 
  geom_line() +
    labs(x = "Date",
       y = "Rate of growth (rolling 3-day window)",
       title = "Rolling 3-day rate of growth: Total COVID-related deaths",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, max(agg.deaths.state$total_deaths_rtgrowth * 1.1)))
agg.deaths.growth.state.plot
```

## Examine state figures per capita
Table of total confirmed cases per capita (all states)

Plot of total confirmed cases over time (top 10 states as of most recent day's data)

Table of new cases per capita: rolling 3-day total (all 50 states)

Plot of new cases per capita: rolling 3-day total (top 10 states as of most recent day's data)

Table of total deaths per capita (all states)

Plot of total deaths per capita over time (top 10 states as of most recent day's data)

Table of new deaths per capita: rolling 3-day total (all 50 states)

Plot of new deaths per capita over time: rolling 3-day total (top 10 states as of most recent day's data)

## Explore growth rates based on stay-at-home orders
Confirmed cases
```{r}
state.dt <- state.raw
state.dt[, stay_date := stay_dates$start_date[match(state.raw$state, stay_dates$state)]]
state.dt[, flgOrder := ifelse(is.na(stay_date), 0, 1)]
#state.dt[, flgOrder := ifelse(is.na(stay_date) | stay_date >= date, 0 ,1)]
#state.dt[, ctDaysFromBaseline := ifelse(flgOrder == 0, as.integer(date - as.Date("2020-03-10")),
#                                         as.integer(date - stay_date))]
state.dt[, ctDaysFromBaseline := as.integer(date - stay_date)]
temp <- state.dt
temp <- temp[, c("date", "state", "cases")]
setnames(temp, "cases", "cases_prev3")
state.dt[, dtPrev3 := date - 3]
state.dt <- merge(state.raw, temp, all.x = T, by.x = c("state", "dtPrev3"), by.y = c("state", "date"))
state.dt[, rtGrowth := cases/cases_prev3 - 1]
state.agg.comp <- state.dt[date >= "2020-03-10" & !state %in% "Puerto Rico" & flgOrder == 1]
state.agg.comp <- state.agg.comp[order(ctDaysFromBaseline, flgOrder),
#                                 .(avgRtGrowth = sum(cases, na.rm = T)/sum(cases_prev3, na.rm = T) - 1),
                          .(avgRtGrowth = mean(rtGrowth, na.rm = T)),
                           by = c("ctDaysFromBaseline", "flgOrder")]
state.agg.comp.plot <- ggplot(state.agg.comp, aes(x = ctDaysFromBaseline, y = avgRtGrowth, colour = as.factor(flgOrder))) +
  geom_point() +
  geom_line(aes(group = flgOrder))
state.agg.comp.plot
```
