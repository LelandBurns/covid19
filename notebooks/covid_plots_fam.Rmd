---
title: "Covid Report for Family"
output:
  html_document:
    toc: true
    toc_depth: 4
    fig_width: 10
date: '`r format(Sys.time(), "%B %d, %Y")`'
---

## Background
Notes and format last updated Apr 16, 2020

* This page shows COVID data broken down into regions that affect our family. It pulls from publicly available raw data from the NY Times, which is reported daily. It's on a one-day lag, so when you see this report, the most recent day included will be that reported the day prior.
* The table of contents above summarizes the major sections and can be used to jump to those sections.
* Each major section is then divided into tabs to allow you to more easily shuffle between geographies and metrics.
  * If you open on your phone, I don't believe the tabs will work, so you'll just see the page as one long, continuous document.
* More detailed descriptions and context can be found in each section.

```{r echo = F, include = F, results = 'hide'}
# load packages
library(data.table)
library(ggplot2)
library(scales)
library(dplyr)
library(lubridate)
library(utils)
library(httr)
library(graphics)
library(RColorBrewer)

# turn off scientific notation
options(scipen = 999)

```

```{r echo = F, include = F, results = 'hide'}
state.raw <- data.table(read.csv(file=url("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv"), header = T))
county.raw <- data.table(read.csv(file=url("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"), header = T))
```

```{r echo = F, include = F, results = 'hide'}
# format dates
state.raw[, date := as.Date(date)]
county.raw[, date := as.Date(date)]

# stay-at-home dates (manually updated locally)
stay_dates <- fread("~/covid19/raw_data/stay_at_home_dates.csv", header = T)
stay_dates[, start_date := as.Date(start_date, format = "%Y-%m-%d")]
stay_dates[, population := as.integer(gsub(",", "", population))]

# county populations
county_pop <- fread("~/covid19/raw_data/county_pop_data.csv", header = T)
# county_pop <- county_pop[grep("County", CTYNAME)]
county_pop[, CTYNAME := gsub("(.*) County", "\\1", CTYNAME)]
```

## Growth rates {.tabset .tabset-fade}

### Heat maps

* The two heat maps below compare how quickly total cases or deaths have grown at various times in our respective geopgraphies.
* The first plot compares growth rate for total cases; the second, growth rate for total deaths.
* The metric used is doubling time, by which I mean how quickly total cases or deaths are doubling.
* The plots track that doubling time at each date for our geographies. Darker colors reflect shorter doubling times, and thus periods of faster growth.
  * You can use the plots to track each geography over time and to compare the geographies to one another.
  * You can also compare the cases and death charts, to see how faster periods of death growth follow faster periods of case growth.


```{r echo = F, message = F, warning = F}
# get data for US
cases.US <- state.raw[order(date),
                      .(cases = sum(cases, na.rm = T)),
                      by = "date"]
temp <- cases.US
cases.US[, casesPrev := temp$cases[match(cases.US$date - 1, temp$date)]]
cases.US[, rtGrowth := cases/casesPrev - 1]

temp <- cases.US
cases.US[, rtGrowthPrev1 := temp$rtGrowth[match(cases.US$date - 1, temp$date)]]
cases.US[, rtGrowthPrev2 := temp$rtGrowth[match(cases.US$date - 2, temp$date)]]

cases.US[, rtGrowthRolling3 := (rtGrowth + rtGrowthPrev1 + rtGrowthPrev2)/3]
cases.US[, daysToDouble := log(2, 1 + rtGrowthRolling3)]

# get data for states
use.state <- c("Washington", "California", "South Carolina", "Tennessee")
cases.state <- state.raw[state %in% use.state]

cases.state[, datePrev := date - 1]
temp <- cases.state[, c("date", "state", "cases")]
setnames(temp, "cases", "casesPrev")
cases.state <- merge(cases.state, temp, all.x = T, by.x = c("datePrev", "state"), by.y = c("date", "state"))
cases.state[, rtGrowth := cases/casesPrev - 1]

temp <- cases.state[, c("date", "state", "rtGrowth")]
setnames(temp, "rtGrowth", "rtGrowthPrev1")
cases.state <- merge(cases.state, temp, all.x = T, by.x = c("datePrev", "state"), by.y = c("date", "state"))

cases.state[, datePrev2 := date - 2]
temp <- cases.state[, c("date", "state", "rtGrowth")]
setnames(temp, "rtGrowth", "rtGrowthPrev2")
cases.state <- merge(cases.state, temp, all.x = T, by.x = c("datePrev2", "state"), by.y = c("date", "state"))

cases.state[, rtGrowthRolling3 := (rtGrowth + rtGrowthPrev1 + rtGrowthPrev2)/3]
cases.state[, daysToDouble := log(2, 1 + rtGrowthRolling3)]

# get data for counties
our.fips <- c(6059, 47037, 53053, 45091, 45079)
cases.county <- county.raw[fips %in% our.fips]

cases.county[, datePrev := date - 1]
temp <- cases.county[, c("date", "county", "cases")]
setnames(temp, "cases", "casesPrev")
cases.county <- merge(cases.county, temp, all.x = T, by.x = c("datePrev", "county"), by.y = c("date", "county"))
cases.county[, rtGrowth := cases/casesPrev - 1]

temp <- cases.county[, c("date", "county", "rtGrowth")]
setnames(temp, "rtGrowth", "rtGrowthPrev1")
cases.county <- merge(cases.county, temp, all.x = T, by.x = c("datePrev", "county"), by.y = c("date", "county"))

cases.county[, datePrev2 := date - 2]
temp <- cases.county[, c("date", "county", "rtGrowth")]
setnames(temp, "rtGrowth", "rtGrowthPrev2")
cases.county <- merge(cases.county, temp, all.x = T, by.x = c("datePrev2", "county"), by.y = c("date", "county"))

cases.county[, rtGrowthRolling3 := (rtGrowth + rtGrowthPrev1 + rtGrowthPrev2)/3]
cases.county[, daysToDouble := log(2, 1 + rtGrowthRolling3)]

# merge data
cases.US[, geo := "U.S."]
cases.US <- cases.US[, c("date", "geo", "daysToDouble", "cases")]

cases.state <- cases.state[, c("date", "state", "daysToDouble", "cases")]
setnames(cases.state, "state", "geo")

cases.county <- cases.county[, c("date", "county", "daysToDouble", "cases")]
setnames(cases.county, "county", "geo")
cases.county[, geo := gsub("(.*)", "\\1 County", geo)]

cases.agg <- rbind(cases.US, cases.state)
cases.agg <- rbind(cases.agg, cases.county)

cases.agg[, daysDoubleBin := ifelse(daysToDouble < 1, "Less than 1 day",
                                    ifelse(daysToDouble >= 1 & daysToDouble < 2, "1-2 days",
                                           ifelse(daysToDouble >= 2 & daysToDouble < 3, "2-3 days",
                                                  ifelse(daysToDouble >= 3 & daysToDouble < 7, "3-7 days",
                                                         ifelse(daysToDouble >= 7 & daysToDouble < 14, "1-2 weeks", "More than 2 weeks")))))]

# try a plot!
use.cases <- cases.agg[date >= "2020-03-01" & !is.na(daysDoubleBin) & cases >= 50]
use.cases[, daysDoubleBin := factor(daysDoubleBin, levels = c("Less than 1 day", "1-2 days", "2-3 days", "3-7 days", "1-2 weeks", "More than 2 weeks"))]

plot.cases.growth <- ggplot(use.cases, aes(x = date, y = geo, fill = daysDoubleBin)) +
  geom_tile() +
  scale_fill_brewer(palette = "YlOrRd", direction = -1) +
    labs(x = "Date",
       y = "Geography",
       title = "Total cases doubling time for our homes",
       subtitle = "Based on rolling 3-day average of daily growth rates",
       fill = "Doubling time") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
plot.cases.growth
```

```{r echo = F, message = F, warning = F}
# get data for US
deaths.US <- state.raw[order(date),
                      .(deaths = sum(deaths, na.rm = T)),
                      by = "date"]
temp <- deaths.US
deaths.US[, deathsPrev := temp$deaths[match(deaths.US$date - 1, temp$date)]]
deaths.US[, rtGrowth := deaths/deathsPrev - 1]

temp <- deaths.US
deaths.US[, rtGrowthPrev1 := temp$rtGrowth[match(deaths.US$date - 1, temp$date)]]
deaths.US[, rtGrowthPrev2 := temp$rtGrowth[match(deaths.US$date - 2, temp$date)]]

deaths.US[, rtGrowthRolling3 := (rtGrowth + rtGrowthPrev1 + rtGrowthPrev2)/3]
deaths.US[, daysToDouble := log(2, 1 + rtGrowthRolling3)]

# get data for states
use.state <- c("Washington", "California", "South Carolina", "Tennessee")
deaths.state <- state.raw[state %in% use.state]

deaths.state[, datePrev := date - 1]
temp <- deaths.state[, c("date", "state", "deaths")]
setnames(temp, "deaths", "deathsPrev")
deaths.state <- merge(deaths.state, temp, all.x = T, by.x = c("datePrev", "state"), by.y = c("date", "state"))
deaths.state[, rtGrowth := deaths/deathsPrev - 1]

temp <- deaths.state[, c("date", "state", "rtGrowth")]
setnames(temp, "rtGrowth", "rtGrowthPrev1")
deaths.state <- merge(deaths.state, temp, all.x = T, by.x = c("datePrev", "state"), by.y = c("date", "state"))

deaths.state[, datePrev2 := date - 2]
temp <- deaths.state[, c("date", "state", "rtGrowth")]
setnames(temp, "rtGrowth", "rtGrowthPrev2")
deaths.state <- merge(deaths.state, temp, all.x = T, by.x = c("datePrev2", "state"), by.y = c("date", "state"))

deaths.state[, rtGrowthRolling3 := (rtGrowth + rtGrowthPrev1 + rtGrowthPrev2)/3]
deaths.state[, daysToDouble := log(2, 1 + rtGrowthRolling3)]

# get data for counties
our.fips <- c(6059, 47037, 53053, 45091, 45079)
deaths.county <- county.raw[fips %in% our.fips]

deaths.county[, datePrev := date - 1]
temp <- deaths.county[, c("date", "county", "deaths")]
setnames(temp, "deaths", "deathsPrev")
deaths.county <- merge(deaths.county, temp, all.x = T, by.x = c("datePrev", "county"), by.y = c("date", "county"))
deaths.county[, rtGrowth := deaths/deathsPrev - 1]

temp <- deaths.county[, c("date", "county", "rtGrowth")]
setnames(temp, "rtGrowth", "rtGrowthPrev1")
deaths.county <- merge(deaths.county, temp, all.x = T, by.x = c("datePrev", "county"), by.y = c("date", "county"))

deaths.county[, datePrev2 := date - 2]
temp <- deaths.county[, c("date", "county", "rtGrowth")]
setnames(temp, "rtGrowth", "rtGrowthPrev2")
deaths.county <- merge(deaths.county, temp, all.x = T, by.x = c("datePrev2", "county"), by.y = c("date", "county"))

deaths.county[, rtGrowthRolling3 := (rtGrowth + rtGrowthPrev1 + rtGrowthPrev2)/3]
deaths.county[, daysToDouble := log(2, 1 + rtGrowthRolling3)]

# merge data
deaths.US[, geo := "U.S."]
deaths.US <- deaths.US[, c("date", "geo", "daysToDouble", "deaths")]

deaths.state <- deaths.state[, c("date", "state", "daysToDouble", "deaths")]
setnames(deaths.state, "state", "geo")

deaths.county <- deaths.county[, c("date", "county", "daysToDouble", "deaths")]
setnames(deaths.county, "county", "geo")
deaths.county[, geo := gsub("(.*)", "\\1 County", geo)]

deaths.agg <- rbind(deaths.US, deaths.state)
deaths.agg <- rbind(deaths.agg, deaths.county)

deaths.agg[, daysDoubleBin := ifelse(daysToDouble < 1, "Less than 1 day",
                                    ifelse(daysToDouble >= 1 & daysToDouble < 2, "1-2 days",
                                           ifelse(daysToDouble >= 2 & daysToDouble < 3, "2-3 days",
                                                  ifelse(daysToDouble >= 3 & daysToDouble < 7, "3-7 days",
                                                         ifelse(daysToDouble >= 7 & daysToDouble < 14, "1-2 weeks", "More than 2 weeks")))))]

# try a plot!
use.deaths <- deaths.agg[date >= "2020-03-01" & !is.na(daysDoubleBin) & deaths >= 3]
use.deaths[, daysDoubleBin := factor(daysDoubleBin, levels = c("Less than 1 day", "1-2 days", "2-3 days", "3-7 days", "1-2 weeks", "More than 2 weeks"))]

plot.deaths.growth <- ggplot(use.deaths, aes(x = date, y = geo, fill = daysDoubleBin)) +
  geom_tile() +
  scale_fill_brewer(palette = "YlOrRd", direction = -1) +
    labs(x = "Date",
       y = "Geography",
       title = "Total deaths doubling time for our homes",
       subtitle = "Based on rolling 3-day average of daily growth rates",
       fill = "Doubling time") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
plot.deaths.growth
```

### Case growth rates {.tabset .tabset-fade}

* This section charts the growth rate of both total and new cases for each of our respective geographies. Each geography has its own chart, and then that chart will have a trendline for total cases and new cases.
  * There are only plots for the U.S. and states because the numbers for the counties are too small to generate worthwhile trendlines in this section.
* Each of these two lines is a rolling three-day average of daily growth rates for that particular metric.
    * For total cases, the trendlines will be a bit smoother and more consistent. We want to see these decline (and almost all are), but they can't go below zero because total cases can never go down. We at least want them to get as close to zero as possible.
    * For new cases, the lines are a bit bumpier, in particular for states. While the trends aren't as smooth, we want to watch for them to get consistently below zero and stay there. That means that we are consistently seeing fewer new cases on a daily basis and that we're on the other side of the "apex."

#### U.S.

```{r echo = F, message = F, warning = F}
agg.cases.US <- state.raw[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]

# make single day total and new cash growth rates
temp <- agg.cases.US
agg.cases.US[, total_cases_prev := temp$total_cases[match(agg.cases.US$date - 1, temp$date)]]
agg.cases.US[, total_cases_rtgrowth := total_cases/total_cases_prev - 1]
agg.cases.US[, new_cases := total_cases - total_cases_prev]
temp <- agg.cases.US
agg.cases.US[, new_cases_prev := temp$new_cases[match(agg.cases.US$date - 1, temp$date)]]
agg.cases.US[, new_cases_rtgrowth := new_cases/new_cases_prev - 1]

# now make a 3-day rolling total avg
temp <- agg.cases.US
agg.cases.US[, total_cases_rtgrowth_prev1 := temp$total_cases_rtgrowth[match(agg.cases.US$date - 1, temp$date)]]
agg.cases.US[, total_cases_rtgrowth_prev2 := temp$total_cases_rtgrowth[match(agg.cases.US$date - 2, temp$date)]]
agg.cases.US[, total_cases_rtgrowth_rolling3 := (total_cases_rtgrowth + total_cases_rtgrowth_prev1 + total_cases_rtgrowth_prev2)/3]

# now make a 3-day rolling new avg
agg.cases.US[, new_cases_rtgrowth_prev1 := temp$new_cases_rtgrowth[match(agg.cases.US$date - 1, temp$date)]]
agg.cases.US[, new_cases_rtgrowth_prev2 := temp$new_cases_rtgrowth[match(agg.cases.US$date - 2, temp$date)]]
agg.cases.US[, new_cases_rtgrowth_rolling3 := (new_cases_rtgrowth + new_cases_rtgrowth_prev1 + new_cases_rtgrowth_prev2)/3]
agg.cases.US[, daysToDouble := log(2, 1 + total_cases_rtgrowth_rolling3)]

melt.use <- melt(agg.cases.US[, c("date", "total_cases_rtgrowth_rolling3", "new_cases_rtgrowth_rolling3")], id.vars = "date")
melt.use[, variable := ifelse(variable %in% "total_cases_rtgrowth_rolling3", "Total Cases", "New Cases")]

agg.cases.growth.US.plot <- ggplot(melt.use[date >= "2020-03-16"], aes(x = date, y = value, color = variable)) + 
  geom_line(aes(group = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    labs(x = "Date",
       y = "Daily growth rate (rolling 3-day avg)",
       title = "Daily growth rate (3-day rolling avg): Confirmed COVID cases",
       subtitle = "United States",
       color = "Metric") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = 
                       c(ifelse(min(melt.use$value) > 0, 0, min(melt.use$value)), max(melt.use$value * 1.1)))
agg.cases.growth.US.plot
```

#### Our states

```{r echo = F, message = F, warning = F}
use.state <- "Washington"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]

# make single day total and new cash growth rates
temp <- agg.cases.state
agg.cases.state[, total_cases_prev := temp$total_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_cases_rtgrowth := total_cases/total_cases_prev - 1]
agg.cases.state[, new_cases := total_cases - total_cases_prev]
temp <- agg.cases.state
agg.cases.state[, new_cases_prev := temp$new_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, new_cases_rtgrowth := new_cases/new_cases_prev - 1]

# now make a 3-day rolling total avg
temp <- agg.cases.state
agg.cases.state[, total_cases_rtgrowth_prev1 := temp$total_cases_rtgrowth[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_cases_rtgrowth_prev2 := temp$total_cases_rtgrowth[match(agg.cases.state$date - 2, temp$date)]]
agg.cases.state[, total_cases_rtgrowth_rolling3 := (total_cases_rtgrowth + total_cases_rtgrowth_prev1 + total_cases_rtgrowth_prev2)/3]

# now make a 3-day rolling new avg
agg.cases.state[, new_cases_rtgrowth_prev1 := temp$new_cases_rtgrowth[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, new_cases_rtgrowth_prev2 := temp$new_cases_rtgrowth[match(agg.cases.state$date - 2, temp$date)]]
agg.cases.state[, new_cases_rtgrowth_rolling3 := (new_cases_rtgrowth + new_cases_rtgrowth_prev1 + new_cases_rtgrowth_prev2)/3]

melt.use <- melt(agg.cases.state[, c("date", "total_cases_rtgrowth_rolling3", "new_cases_rtgrowth_rolling3")], id.vars = "date")
melt.use[, variable := ifelse(variable %in% "total_cases_rtgrowth_rolling3", "Total Cases", "New Cases")]

agg.cases.growth.state.plot <- ggplot(melt.use[date >= "2020-03-16"], aes(x = date, y = value, color = variable)) + 
  geom_line(aes(group = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    labs(x = "Date",
       y = "Daily growth rate (rolling 3-day avg)",
       title = "Daily growth rate (3-day rolling avg): Confirmed COVID cases",
       subtitle = use.state,
       color = "Metric") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = 
                       c(ifelse(min(melt.use$value) > 0, 0, min(melt.use$value)), max(melt.use$value * 1.1)))
agg.cases.growth.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "California"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]

# make single day total and new cash growth rates
temp <- agg.cases.state
agg.cases.state[, total_cases_prev := temp$total_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_cases_rtgrowth := total_cases/total_cases_prev - 1]
agg.cases.state[, new_cases := total_cases - total_cases_prev]
temp <- agg.cases.state
agg.cases.state[, new_cases_prev := temp$new_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, new_cases_rtgrowth := new_cases/new_cases_prev - 1]

# now make a 3-day rolling total avg
temp <- agg.cases.state
agg.cases.state[, total_cases_rtgrowth_prev1 := temp$total_cases_rtgrowth[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_cases_rtgrowth_prev2 := temp$total_cases_rtgrowth[match(agg.cases.state$date - 2, temp$date)]]
agg.cases.state[, total_cases_rtgrowth_rolling3 := (total_cases_rtgrowth + total_cases_rtgrowth_prev1 + total_cases_rtgrowth_prev2)/3]

# now make a 3-day rolling new avg
agg.cases.state[, new_cases_rtgrowth_prev1 := temp$new_cases_rtgrowth[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, new_cases_rtgrowth_prev2 := temp$new_cases_rtgrowth[match(agg.cases.state$date - 2, temp$date)]]
agg.cases.state[, new_cases_rtgrowth_rolling3 := (new_cases_rtgrowth + new_cases_rtgrowth_prev1 + new_cases_rtgrowth_prev2)/3]

melt.use <- melt(agg.cases.state[, c("date", "total_cases_rtgrowth_rolling3", "new_cases_rtgrowth_rolling3")], id.vars = "date")
melt.use[, variable := ifelse(variable %in% "total_cases_rtgrowth_rolling3", "Total Cases", "New Cases")]

agg.cases.growth.state.plot <- ggplot(melt.use[date >= "2020-03-16"], aes(x = date, y = value, color = variable)) + 
  geom_line(aes(group = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    labs(x = "Date",
       y = "Daily growth rate (rolling 3-day avg)",
       title = "Daily growth rate (3-day rolling avg): Confirmed COVID cases",
       subtitle = use.state,
       color = "Metric") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = 
                       c(ifelse(min(melt.use$value) > 0, 0, min(melt.use$value)), max(melt.use$value * 1.1)))
agg.cases.growth.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "South Carolina"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]

# make single day total and new cash growth rates
temp <- agg.cases.state
agg.cases.state[, total_cases_prev := temp$total_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_cases_rtgrowth := total_cases/total_cases_prev - 1]
agg.cases.state[, new_cases := total_cases - total_cases_prev]
temp <- agg.cases.state
agg.cases.state[, new_cases_prev := temp$new_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, new_cases_rtgrowth := new_cases/new_cases_prev - 1]

# now make a 3-day rolling total avg
temp <- agg.cases.state
agg.cases.state[, total_cases_rtgrowth_prev1 := temp$total_cases_rtgrowth[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_cases_rtgrowth_prev2 := temp$total_cases_rtgrowth[match(agg.cases.state$date - 2, temp$date)]]
agg.cases.state[, total_cases_rtgrowth_rolling3 := (total_cases_rtgrowth + total_cases_rtgrowth_prev1 + total_cases_rtgrowth_prev2)/3]

# now make a 3-day rolling new avg
agg.cases.state[, new_cases_rtgrowth_prev1 := temp$new_cases_rtgrowth[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, new_cases_rtgrowth_prev2 := temp$new_cases_rtgrowth[match(agg.cases.state$date - 2, temp$date)]]
agg.cases.state[, new_cases_rtgrowth_rolling3 := (new_cases_rtgrowth + new_cases_rtgrowth_prev1 + new_cases_rtgrowth_prev2)/3]

melt.use <- melt(agg.cases.state[, c("date", "total_cases_rtgrowth_rolling3", "new_cases_rtgrowth_rolling3")], id.vars = "date")
melt.use[, variable := ifelse(variable %in% "total_cases_rtgrowth_rolling3", "Total Cases", "New Cases")]

agg.cases.growth.state.plot <- ggplot(melt.use[date >= "2020-03-16"], aes(x = date, y = value, color = variable)) + 
  geom_line(aes(group = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    labs(x = "Date",
       y = "Daily growth rate (rolling 3-day avg)",
       title = "Daily growth rate (3-day rolling avg): Confirmed COVID cases",
       subtitle = use.state,
       color = "Metric") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = 
                       c(ifelse(min(melt.use$value) > 0, 0, min(melt.use$value)), max(melt.use$value * 1.1)))
agg.cases.growth.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "Tennessee"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]

# make single day total and new cash growth rates
temp <- agg.cases.state
agg.cases.state[, total_cases_prev := temp$total_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_cases_rtgrowth := total_cases/total_cases_prev - 1]
agg.cases.state[, new_cases := total_cases - total_cases_prev]
temp <- agg.cases.state
agg.cases.state[, new_cases_prev := temp$new_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, new_cases_rtgrowth := new_cases/new_cases_prev - 1]

# now make a 3-day rolling total avg
temp <- agg.cases.state
agg.cases.state[, total_cases_rtgrowth_prev1 := temp$total_cases_rtgrowth[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_cases_rtgrowth_prev2 := temp$total_cases_rtgrowth[match(agg.cases.state$date - 2, temp$date)]]
agg.cases.state[, total_cases_rtgrowth_rolling3 := (total_cases_rtgrowth + total_cases_rtgrowth_prev1 + total_cases_rtgrowth_prev2)/3]

# now make a 3-day rolling new avg
agg.cases.state[, new_cases_rtgrowth_prev1 := temp$new_cases_rtgrowth[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, new_cases_rtgrowth_prev2 := temp$new_cases_rtgrowth[match(agg.cases.state$date - 2, temp$date)]]
agg.cases.state[, new_cases_rtgrowth_rolling3 := (new_cases_rtgrowth + new_cases_rtgrowth_prev1 + new_cases_rtgrowth_prev2)/3]

melt.use <- melt(agg.cases.state[, c("date", "total_cases_rtgrowth_rolling3", "new_cases_rtgrowth_rolling3")], id.vars = "date")
melt.use[, variable := ifelse(variable %in% "total_cases_rtgrowth_rolling3", "Total Cases", "New Cases")]

agg.cases.growth.state.plot <- ggplot(melt.use[date >= "2020-03-16"], aes(x = date, y = value, color = variable)) + 
  geom_line(aes(group = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    labs(x = "Date",
       y = "Daily growth rate (rolling 3-day avg)",
       title = "Daily growth rate (3-day rolling avg): Confirmed COVID cases",
       subtitle = use.state,
       color = "Metric") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = 
                       c(ifelse(min(melt.use$value) > 0, 0, min(melt.use$value)), max(melt.use$value * 1.1)))
agg.cases.growth.state.plot
```

### Death growth rates {.tabset .tabset-fade}

* This section charts the growth rate of both total and new deaths for each of our respective geographies. Each geography has its own chart, and then that chart will have a trendline for total deaths and new deaths.
  * There are only plots for the U.S. and states because the numbers for the counties are too small to generate worthwhile trendlines in this section.
* Each of these two lines is a rolling three-day average of daily growth rates for that particular metric.
    * For total deaths, the trendlines will be a bit smoother and more consistent. We want to see these decline (and almost all are), but they can't go below zero because total deaths can never go down. We at least want them to get as close to zero as possible.
    * For new deaths, the lines are a bit bumpier, in particular for states. While the trends aren't as smooth, we want to watch for them to get consistently below zero and stay there. That means that we are consistently seeing fewer new deaths on a daily basis and that we're on the other side of the "apex."

#### U.S.

```{r echo = F, message = F, warning = F}
agg.deaths.US <- state.raw[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]

# make single day total and new cash growth rates
temp <- agg.deaths.US
agg.deaths.US[, total_deaths_prev := temp$total_deaths[match(agg.deaths.US$date - 1, temp$date)]]
agg.deaths.US[, total_deaths_rtgrowth := total_deaths/total_deaths_prev - 1]
agg.deaths.US[, new_deaths := total_deaths - total_deaths_prev]
temp <- agg.deaths.US
agg.deaths.US[, new_deaths_prev := temp$new_deaths[match(agg.deaths.US$date - 1, temp$date)]]
agg.deaths.US[, new_deaths_rtgrowth := new_deaths/new_deaths_prev - 1]

# now make a 3-day rolling total avg
temp <- agg.deaths.US
agg.deaths.US[, total_deaths_rtgrowth_prev1 := temp$total_deaths_rtgrowth[match(agg.deaths.US$date - 1, temp$date)]]
agg.deaths.US[, total_deaths_rtgrowth_prev2 := temp$total_deaths_rtgrowth[match(agg.deaths.US$date - 2, temp$date)]]
agg.deaths.US[, total_deaths_rtgrowth_rolling3 := (total_deaths_rtgrowth + total_deaths_rtgrowth_prev1 + total_deaths_rtgrowth_prev2)/3]

# now make a 3-day rolling new avg
agg.deaths.US[, new_deaths_rtgrowth_prev1 := temp$new_deaths_rtgrowth[match(agg.deaths.US$date - 1, temp$date)]]
agg.deaths.US[, new_deaths_rtgrowth_prev2 := temp$new_deaths_rtgrowth[match(agg.deaths.US$date - 2, temp$date)]]
agg.deaths.US[, new_deaths_rtgrowth_rolling3 := (new_deaths_rtgrowth + new_deaths_rtgrowth_prev1 + new_deaths_rtgrowth_prev2)/3]
agg.deaths.US[, daysToDouble := log(2, 1 + total_deaths_rtgrowth_rolling3)]

melt.use <- melt(agg.deaths.US[, c("date", "total_deaths_rtgrowth_rolling3", "new_deaths_rtgrowth_rolling3")], id.vars = "date")
melt.use[, variable := ifelse(variable %in% "total_deaths_rtgrowth_rolling3", "Total Deaths", "New Deaths")]

agg.deaths.growth.US.plot <- ggplot(melt.use[date >= "2020-03-16"], aes(x = date, y = value, color = variable)) + 
  geom_line(aes(group = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    labs(x = "Date",
       y = "Daily growth rate (rolling 3-day avg)",
       title = "Daily growth rate (3-day rolling avg): Confirmed COVID deaths",
       subtitle = "United States",
       color = "Metric") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = 
                       c(ifelse(min(melt.use$value) > 0, 0, min(melt.use$value)), max(melt.use$value * 1.1)))
agg.deaths.growth.US.plot
```

#### Our states

```{r echo = F, message = F, warning = F}
use.state <- "Washington"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- deaths.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]

# make single day total and new cash growth rates
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_prev := temp$total_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth := total_deaths/total_deaths_prev - 1]
agg.deaths.state[, new_deaths := total_deaths - total_deaths_prev]
temp <- agg.deaths.state
agg.deaths.state[, new_deaths_prev := temp$new_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth := new_deaths/new_deaths_prev - 1]

# now make a 3-day rolling total avg
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_rtgrowth_prev1 := temp$total_deaths_rtgrowth[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth_prev2 := temp$total_deaths_rtgrowth[match(agg.deaths.state$date - 2, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth_rolling3 := (total_deaths_rtgrowth + total_deaths_rtgrowth_prev1 + total_deaths_rtgrowth_prev2)/3]

# now make a 3-day rolling new avg
agg.deaths.state[, new_deaths_rtgrowth_prev1 := temp$new_deaths_rtgrowth[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth_prev2 := temp$new_deaths_rtgrowth[match(agg.deaths.state$date - 2, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth_rolling3 := (new_deaths_rtgrowth + new_deaths_rtgrowth_prev1 + new_deaths_rtgrowth_prev2)/3]

melt.use <- melt(agg.deaths.state[, c("date", "total_deaths_rtgrowth_rolling3", "new_deaths_rtgrowth_rolling3")], id.vars = "date")
melt.use[, variable := ifelse(variable %in% "total_deaths_rtgrowth_rolling3", "Total Deaths", "New Deaths")]

agg.deaths.growth.state.plot <- ggplot(melt.use[date >= "2020-03-16"], aes(x = date, y = value, color = variable)) + 
  geom_line(aes(group = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    labs(x = "Date",
       y = "Daily growth rate (rolling 3-day avg)",
       title = "Daily growth rate (3-day rolling avg): Confirmed COVID deaths",
       subtitle = use.state,
       color = "Metric") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = 
                       c(ifelse(min(melt.use$value) > 0, 0, min(melt.use$value)), max(melt.use$value * 1.1)))
agg.deaths.growth.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "California"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- deaths.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]

# make single day total and new cash growth rates
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_prev := temp$total_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth := total_deaths/total_deaths_prev - 1]
agg.deaths.state[, new_deaths := total_deaths - total_deaths_prev]
temp <- agg.deaths.state
agg.deaths.state[, new_deaths_prev := temp$new_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth := new_deaths/new_deaths_prev - 1]

# now make a 3-day rolling total avg
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_rtgrowth_prev1 := temp$total_deaths_rtgrowth[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth_prev2 := temp$total_deaths_rtgrowth[match(agg.deaths.state$date - 2, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth_rolling3 := (total_deaths_rtgrowth + total_deaths_rtgrowth_prev1 + total_deaths_rtgrowth_prev2)/3]

# now make a 3-day rolling new avg
agg.deaths.state[, new_deaths_rtgrowth_prev1 := temp$new_deaths_rtgrowth[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth_prev2 := temp$new_deaths_rtgrowth[match(agg.deaths.state$date - 2, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth_rolling3 := (new_deaths_rtgrowth + new_deaths_rtgrowth_prev1 + new_deaths_rtgrowth_prev2)/3]

melt.use <- melt(agg.deaths.state[, c("date", "total_deaths_rtgrowth_rolling3", "new_deaths_rtgrowth_rolling3")], id.vars = "date")
melt.use[, variable := ifelse(variable %in% "total_deaths_rtgrowth_rolling3", "Total Deaths", "New Deaths")]

agg.deaths.growth.state.plot <- ggplot(melt.use[date >= "2020-03-16"], aes(x = date, y = value, color = variable)) + 
  geom_line(aes(group = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    labs(x = "Date",
       y = "Daily growth rate (rolling 3-day avg)",
       title = "Daily growth rate (3-day rolling avg): Confirmed COVID deaths",
       subtitle = use.state,
       color = "Metric") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = 
                       c(ifelse(min(melt.use$value) > 0, 0, min(melt.use$value)), max(melt.use$value * 1.1)))
agg.deaths.growth.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "South Carolina"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- deaths.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]

# make single day total and new cash growth rates
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_prev := temp$total_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth := total_deaths/total_deaths_prev - 1]
agg.deaths.state[, new_deaths := total_deaths - total_deaths_prev]
temp <- agg.deaths.state
agg.deaths.state[, new_deaths_prev := temp$new_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth := new_deaths/new_deaths_prev - 1]

# now make a 3-day rolling total avg
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_rtgrowth_prev1 := temp$total_deaths_rtgrowth[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth_prev2 := temp$total_deaths_rtgrowth[match(agg.deaths.state$date - 2, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth_rolling3 := (total_deaths_rtgrowth + total_deaths_rtgrowth_prev1 + total_deaths_rtgrowth_prev2)/3]

# now make a 3-day rolling new avg
agg.deaths.state[, new_deaths_rtgrowth_prev1 := temp$new_deaths_rtgrowth[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth_prev2 := temp$new_deaths_rtgrowth[match(agg.deaths.state$date - 2, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth_rolling3 := (new_deaths_rtgrowth + new_deaths_rtgrowth_prev1 + new_deaths_rtgrowth_prev2)/3]

melt.use <- melt(agg.deaths.state[, c("date", "total_deaths_rtgrowth_rolling3", "new_deaths_rtgrowth_rolling3")], id.vars = "date")
melt.use[, variable := ifelse(variable %in% "total_deaths_rtgrowth_rolling3", "Total Deaths", "New Deaths")]

agg.deaths.growth.state.plot <- ggplot(melt.use[date >= "2020-03-16"], aes(x = date, y = value, color = variable)) + 
  geom_line(aes(group = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    labs(x = "Date",
       y = "Daily growth rate (rolling 3-day avg)",
       title = "Daily growth rate (3-day rolling avg): Confirmed COVID deaths",
       subtitle = use.state,
       color = "Metric") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = 
                       c(ifelse(min(melt.use$value) > 0, 0, min(melt.use$value)), max(melt.use$value * 1.1)))
agg.deaths.growth.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "Tennessee"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- deaths.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]

# make single day total and new cash growth rates
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_prev := temp$total_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth := total_deaths/total_deaths_prev - 1]
agg.deaths.state[, new_deaths := total_deaths - total_deaths_prev]
temp <- agg.deaths.state
agg.deaths.state[, new_deaths_prev := temp$new_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth := new_deaths/new_deaths_prev - 1]

# now make a 3-day rolling total avg
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_rtgrowth_prev1 := temp$total_deaths_rtgrowth[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth_prev2 := temp$total_deaths_rtgrowth[match(agg.deaths.state$date - 2, temp$date)]]
agg.deaths.state[, total_deaths_rtgrowth_rolling3 := (total_deaths_rtgrowth + total_deaths_rtgrowth_prev1 + total_deaths_rtgrowth_prev2)/3]

# now make a 3-day rolling new avg
agg.deaths.state[, new_deaths_rtgrowth_prev1 := temp$new_deaths_rtgrowth[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth_prev2 := temp$new_deaths_rtgrowth[match(agg.deaths.state$date - 2, temp$date)]]
agg.deaths.state[, new_deaths_rtgrowth_rolling3 := (new_deaths_rtgrowth + new_deaths_rtgrowth_prev1 + new_deaths_rtgrowth_prev2)/3]

melt.use <- melt(agg.deaths.state[, c("date", "total_deaths_rtgrowth_rolling3", "new_deaths_rtgrowth_rolling3")], id.vars = "date")
melt.use[, variable := ifelse(variable %in% "total_deaths_rtgrowth_rolling3", "Total Deaths", "New Deaths")]

agg.deaths.growth.state.plot <- ggplot(melt.use[date >= "2020-03-16"], aes(x = date, y = value, color = variable)) + 
  geom_line(aes(group = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    labs(x = "Date",
       y = "Daily growth rate (rolling 3-day avg)",
       title = "Daily growth rate (3-day rolling avg): Confirmed COVID deaths",
       subtitle = use.state,
       color = "Metric") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = 
                       c(ifelse(min(melt.use$value) > 0, 0, min(melt.use$value)), max(melt.use$value * 1.1)))
agg.deaths.growth.state.plot
```

## By population rankings {.tabset .tabset-fade}

This section tracks metrics for states and counties normalized for population (number of cases or deaths per million residents), and then compares these figures both for our geographies and the country overall.

### States {.tabset .tabset-fade}

* This section shows tables ranking all 50 states for per populations rates of total cases, new cases, total deaths, and new deaths.
* For each metric, in addition to the tables, the trends for the top states are plotted over time.
  * We only plot the top ten states for each metric so that the plots aren't too crowded. But you can view the full 50-state rankings in the tables.

#### Total confirmed cases

Table of total confirmed cases per million residents (all 50 states)
```{r echo = F, message = F, warning = F}
state.per.cap <- merge(state.raw, stay_dates, by = "state", all.x = T)
state.per.cap[, casesPerMillion := as.integer(cases/population * 1000000)]
date.cut <- max(state.per.cap$date)
state.per.cap.agg <- state.per.cap[date == date.cut]
state.per.cap.agg <- state.per.cap.agg[order(-casesPerMillion), c("state", "casesPerMillion")]
state.per.cap.agg[, casesPerMillion := comma(casesPerMillion)]
state.per.cap.agg
```

```{r echo = F, message = F, warning = F}
state.per.cap.agg[, row := .I]
top.ten <- state.per.cap.agg[row < 11, "state"]
state.per.cap.series <- state.per.cap[state %in% top.ten$state]
state.per.cap.plot <- ggplot(state.per.cap.series[date >= "2020-03-01"], aes(x = date, y = casesPerMillion, colour = state)) +
  geom_line(aes(group = state)) +
    labs(x = "Date",
       y = "Total confirmed COVID cases per million residents",
       title = "Total confirmed COVID cases per million residents",
       subtitle = paste0("States with 10 highest counts as of ", format(date.cut, "%B %d, %Y"))) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
state.per.cap.plot
```

#### New confirmed cases

Table of new cases per million residents: rolling 3-day average (all 50 states)
```{r echo = F, message = F, warning = F}
state.per.cap <- merge(state.raw, stay_dates, by = "state", all.x = T)
date.cut <- max(state.per.cap$date)
date.min <- max(state.per.cap$date) - 3
state.per.cap.agg <- state.per.cap[date == date.cut]
temp <- state.per.cap[date == date.min]
state.per.cap.agg[, casesPrev3 := temp$cases[match(state.per.cap.agg$state, temp$state)]]
state.per.cap.agg[, newCasesPrev3 := (cases - casesPrev3)/3]
state.per.cap.agg[, casesNewPerMillion := as.integer(newCasesPrev3/population * 1000000)]
state.per.cap.agg <- state.per.cap.agg[order(-casesNewPerMillion), c("state", "casesNewPerMillion")]
state.per.cap.agg[, casesNewPerMillion := comma(casesNewPerMillion)]
state.per.cap.agg
```

```{r echo = F, message = F, warning = F}
state.per.cap.agg[, row := .I]
top.ten <- state.per.cap.agg[row < 11, "state"]
state.per.cap.series <- state.per.cap[state %in% top.ten$state]
temp <- state.per.cap.series[, c("state", "date", "cases")]
setnames(temp, "cases", "casesPrev3")
state.per.cap.series[, datePrev3 := date - 3]
state.per.cap.series <- merge(state.per.cap.series, temp, all.x = T, by.x = c("state", "datePrev3"), by.y = c("state", "date"))
state.per.cap.series[, newCasesPrev3 := (cases - casesPrev3)/3]
state.per.cap.series[, casesNewPerMillion := as.integer(newCasesPrev3/population * 1000000)]
state.per.cap.plot <- ggplot(state.per.cap.series[date >= "2020-03-10"], aes(x = date, y = casesNewPerMillion, colour = state)) +
  geom_line(aes(group = state)) +
    labs(x = "Date",
       y = "New confirmed COVID cases per million residents",
       title = "New confirmed COVID cases per million resident (3-day rolling average)",
       subtitle = paste0("States with 10 highest counts as of ", format(date.cut, "%B %d, %Y"))) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
state.per.cap.plot
```

#### Total deaths

Table of total deaths per million residents (all 50 states)
```{r echo = F, message = F, warning = F}
state.per.cap <- merge(state.raw, stay_dates, by = "state", all.x = T)
state.per.cap[, deathsPerMillion := as.integer(deaths/population * 1000000)]
date.cut <- max(state.per.cap$date)
state.per.cap.agg <- state.per.cap[date == date.cut]
state.per.cap.agg <- state.per.cap.agg[order(-deathsPerMillion), c("state", "deathsPerMillion")]
state.per.cap.agg[, deathsPerMillion := comma(deathsPerMillion)]
state.per.cap.agg
```

```{r echo = F, message = F, warning = F}
state.per.cap.agg[, row := .I]
top.ten <- state.per.cap.agg[row < 11, "state"]
state.per.cap.series <- state.per.cap[state %in% top.ten$state]
state.per.cap.plot <- ggplot(state.per.cap.series[date >= "2020-03-01"], aes(x = date, y = deathsPerMillion, colour = state)) +
  geom_line(aes(group = state)) +
    labs(x = "Date",
       y = "Total COVID-related deaths per million residents",
       title = "Total COVID-related deaths per million residents",
       subtitle = paste0("States with 10 highest counts as of ", format(date.cut, "%B %d, %Y"))) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
state.per.cap.plot
```

#### New deaths

Table of new deaths per million residents: rolling 3-day average (all 50 states)
```{r echo = F, message = F, warning = F}
state.per.cap <- merge(state.raw, stay_dates, by = "state", all.x = T)
date.cut <- max(state.per.cap$date)
date.min <- max(state.per.cap$date) - 3
state.per.cap.agg <- state.per.cap[date == date.cut]
temp <- state.per.cap[date == date.min]
state.per.cap.agg[, deathsPrev3 := temp$deaths[match(state.per.cap.agg$state, temp$state)]]
state.per.cap.agg[, newDeathsPrev3 := (deaths - deathsPrev3)/3]
state.per.cap.agg[, deathsNewPerMillion := as.integer(newDeathsPrev3/population * 1000000)]
state.per.cap.agg <- state.per.cap.agg[order(-deathsNewPerMillion), c("state", "deathsNewPerMillion")]
state.per.cap.agg[, deathsNewPerMillion := comma(deathsNewPerMillion)]
state.per.cap.agg
```

```{r echo = F, message = F, warning = F}
state.per.cap.agg[, row := .I]
top.ten <- state.per.cap.agg[row < 11, "state"]
state.per.cap.series <- state.per.cap[state %in% top.ten$state]
temp <- state.per.cap.series[, c("state", "date", "deaths")]
setnames(temp, "deaths", "deathsPrev3")
state.per.cap.series[, datePrev3 := date - 3]
state.per.cap.series <- merge(state.per.cap.series, temp, all.x = T, by.x = c("state", "datePrev3"), by.y = c("state", "date"))
state.per.cap.series[, newDeathsPrev3 := (deaths - deathsPrev3)/3]
state.per.cap.series[, deathsNewPerMillion := as.integer(newDeathsPrev3/population * 1000000)]
state.per.cap.plot <- ggplot(state.per.cap.series[date >= "2020-03-10"], aes(x = date, y = deathsNewPerMillion, colour = state)) +
  geom_line(aes(group = state)) +
    labs(x = "Date",
       y = "New COVID-related deaths per million residents",
       title = "New COVID-related deaths per million resident (3-day rolling average)",
       subtitle = paste0("States with 10 highest counts as of ", format(date.cut, "%B %d, %Y"))) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
state.per.cap.plot
```

### Counties {.tabset .tabset-fade}

* This section focuses on the county level. It shows tables with our counties ranked by percentile of U.S. counties for per population rates of total cases and total deaths.
  * Each table also shows the top five counties in the country in addition to our counties, for added perspecive.
* In addition to the tables, our counties' percentile for both total cases and total deaths are plotted over time.

#### Confirmed cases

Table showing total cases per million and percentile for all US counties.
Includes our counties and the top 5 in the US for perspective.
```{r  echo = F, message = F, warning = F}
# merge county raw and county pop
county.use <- county.raw
county.use[, county := gsub("(.*) City", "\\1", county)]
county.per.cap <- merge(county.use, county_pop, all.x = T, by.x = c("county", "state"), by.y = c("CTYNAME", "STNAME"))
county.per.cap[, casesPerMillion := round(cases/POPESTIMATE2019 * 1000000, 2)]
date.cut <- max(county.per.cap$date)
county.per.cap <- county.per.cap[date == date.cut]
county.per.cap <- county.per.cap[order(-casesPerMillion), c("county", "state", "casesPerMillion")]
county.per.cap[, rawRanking := .I]
county.per.cap[, percentile := floor((3142 - rawRanking)/31.42)]
county.per.cap[, casesPerMillion := comma(casesPerMillion)]
county.per.cap[, flgOurCounty := ifelse(county %in% "Pierce" & state %in% "Washington", 1,
                                       ifelse(county %in% "Orange" & state %in% "California", 1,
                                              ifelse(county %in% c("Richland", "York") & state %in% "South Carolina", 1,
                                                     ifelse(county %in% "Davidson" & state %in% "Tennessee", 1, 0))))]
county.per.cap[flgOurCounty == 1 | rawRanking < 6, -c("flgOurCounty")]
```

Our county percentiles over time
```{r  echo = F, message = F, warning = F}
county.use <- county.raw
county.use[, county := gsub("(.*) City", "\\1", county)]
county.per.cap <- merge(county.use, county_pop, all.x = T, by.x = c("county", "state"), by.y = c("CTYNAME", "STNAME"))
county.per.cap[, casesPerMillion := round(cases/POPESTIMATE2019 * 1000000, 2)]
county.per.cap <- county.per.cap[order(fips, date),
                                 .(casesPerMillion = max(casesPerMillion)),
                                 by = c("fips", "date")]

county.per.cap <- county.per.cap[!is.na(casesPerMillion) & as.Date(date) >= "2020-03-16"]
county.per.cap.casted <- dcast.data.table(county.per.cap, factor(fips) ~ factor(date), value.var = "casesPerMillion", fun.aggregate = sum)
for(i in seq.Date(as.Date("2020-03-16"), max(as.Date(county.raw$date)), by = "day")) {
 # i <- "2020-04-07" 
  i <- format(as.Date(i, origin = "1970-01-01"), "%Y-%m-%d")
    colnames <- c("fips", as.character(i))
    temp <- county.per.cap.casted[, ..colnames]
    setnames(temp, as.character(i), "casesPerMillion")
    temp <- temp[order(-casesPerMillion)]
    temp[, rawRanking := .I]
    temp[, paste0("percentile_", as.character(i)) := floor((3142 - rawRanking)/31.42)]
    county.per.cap.casted <- merge(county.per.cap.casted, temp[, c(1,4)], all.x = T, by = "fips")
}

setnames(county.per.cap.casted, "fips", "percentile_fips")
county.per.cap.casted <- county.per.cap.casted[, .SD, .SDcols = patterns("^percentile")]
county.per.cap.melt <- melt(county.per.cap.casted, id.var = "percentile_fips")
county.per.cap.melt[, variable := gsub("percentile_(.*)", "\\1", variable)]
our.fips <- c(6059, 47037, 53053, 45091, 45079)
county.per.cap.melt <- county.per.cap.melt[percentile_fips %in% our.fips]

county.per.cap.melt[, county := county.raw$county[match(county.per.cap.melt$percentile_fips, county.raw$fips)]]

plot.county.per.cap <- ggplot(county.per.cap.melt, aes(x = as.Date(variable), y = value, color = county)) +
  geom_line(aes(group = county)) +
    labs(x = "Date",
       y = "Percentile of US counties",
       title = "Our county percentiles for total COVID cases",
       subtitle = "Percentiles based on total cases per million residents",
       color = "County") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
plot.county.per.cap
```

#### Deaths

Table showing total deaths per million and percentile for all US counties.
Includes our counties and the top 5 in the US for perspective.
```{r  echo = F, message = F, warning = F}
county.use <- county.raw
county.use[, county := gsub("(.*) City", "\\1", county)]
county.per.cap <- merge(county.use, county_pop, all.x = T, by.x = c("county", "state"), by.y = c("CTYNAME", "STNAME"))
county.per.cap[, deathsPerMillion := round(deaths/POPESTIMATE2019 * 1000000, 2)]
date.cut <- max(county.per.cap$date)
county.per.cap <- county.per.cap[date == date.cut]
county.per.cap <- county.per.cap[order(-deathsPerMillion), c("county", "state", "deathsPerMillion")]
county.per.cap[, rawRanking := .I]
county.per.cap[, percentile := floor((3142 - rawRanking)/31.42)]
county.per.cap[, deathsPerMillion := comma(deathsPerMillion)]
county.per.cap[, flgOurCounty := ifelse(county %in% "Pierce" & state %in% "Washington", 1,
                                       ifelse(county %in% "Orange" & state %in% "California", 1,
                                              ifelse(county %in% c("Richland", "York") & state %in% "South Carolina", 1,
                                                     ifelse(county %in% "Davidson" & state %in% "Tennessee", 1, 0))))]
county.per.cap[flgOurCounty == 1 | rawRanking < 6, -c("flgOurCounty")]
```

Our county percentiles over time
```{r  echo = F, message = F, warning = F}
county.use <- county.raw
county.use[, county := gsub("(.*) City", "\\1", county)]
county.per.cap <- merge(county.use, county_pop, all.x = T, by.x = c("county", "state"), by.y = c("CTYNAME", "STNAME"))
county.per.cap[, deathsPerMillion := round(deaths/POPESTIMATE2019 * 1000000, 2)]
county.per.cap <- county.per.cap[order(fips, date),
                                 .(deathsPerMillion = max(deathsPerMillion)),
                                 by = c("fips", "date")]

county.per.cap <- county.per.cap[!is.na(deathsPerMillion) & as.Date(date) >= "2020-03-16"]
county.per.cap.casted <- dcast.data.table(county.per.cap, factor(fips) ~ factor(date), value.var = "deathsPerMillion", fun.aggregate = sum)
for(i in seq.Date(as.Date("2020-03-16"), max(as.Date(county.raw$date)), by = "day")) {
 # i <- "2020-04-07" 
  i <- format(as.Date(i, origin = "1970-01-01"), "%Y-%m-%d")
    colnames <- c("fips", as.character(i))
    temp <- county.per.cap.casted[, ..colnames]
    setnames(temp, as.character(i), "deathsPerMillion")
    temp <- temp[order(-deathsPerMillion)]
    temp[, rawRanking := .I]
    temp[, paste0("percentile_", as.character(i)) := floor((3142 - rawRanking)/31.42)]
    county.per.cap.casted <- merge(county.per.cap.casted, temp[, c(1,4)], all.x = T, by = "fips")
}

setnames(county.per.cap.casted, "fips", "percentile_fips")
county.per.cap.casted <- county.per.cap.casted[, .SD, .SDcols = patterns("^percentile")]
county.per.cap.melt <- melt(county.per.cap.casted, id.var = "percentile_fips")
county.per.cap.melt[, variable := gsub("percentile_(.*)", "\\1", variable)]
our.fips <- c(6059, 47037, 53053, 45091, 45079)
county.per.cap.melt <- county.per.cap.melt[percentile_fips %in% our.fips]

county.per.cap.melt[, county := county.raw$county[match(county.per.cap.melt$percentile_fips, county.raw$fips)]]

plot.county.per.cap <- ggplot(county.per.cap.melt, aes(x = as.Date(variable), y = value, color = county)) +
  geom_line(aes(group = county)) +
    labs(x = "Date",
       y = "Percentile of US counties",
       title = "Our county percentiles for total COVID deaths",
       subtitle = "Percentiles based on total deaths per million residents",
       color = "County") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
plot.county.per.cap
```

## Raw counts {.tabset .tabset-fade}

* This section shows the raw counts over time for the U.S., our states, and our counties for four categories:
  * Total confirmed cases: This is the cumulative total of cases reported.
  * New confirmed cases: This is the number of new cases reported on each respective date.
    * For the U.S. and states, a trendline shows the rolling 7-day average of new cases, to help better visualize the peak.
  * Total deaths: This is the cumulative total of deaths reported.
  * New deaths: This is the number of new deaths reported on each respective date.
      * For the U.S. and states, a trendline shows the rolling 7-day average of new deaths, to help better visualize the peak.

### Total confirmed cases {.tabset .tabset-fade}

#### U.S.

```{r echo = F, message = F, warning = F}
agg.cases.US <- state.raw[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.US.plot <- ggplot(agg.cases.US[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = "United States") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.cases.US.plot
```

#### Our states

```{r echo = F, message = F, warning = F}
# adjust state name to flow through rest of code (use capitalized full state name)
use.state <- "Washington"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.state.plot <- ggplot(agg.cases.state[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.cases.state.plot
```

```{r echo = F, message = F, warning = F}
# adjust state name to flow through rest of code (use capitalized full state name)
use.state <- "California"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.state.plot <- ggplot(agg.cases.state[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.cases.state.plot
```

```{r echo = F, message = F, warning = F}
# adjust state name to flow through rest of code (use capitalized full state name)
use.state <- "South Carolina"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.state.plot <- ggplot(agg.cases.state[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.cases.state.plot
```

```{r echo = F, message = F, warning = F}
# adjust state name to flow through rest of code (use capitalized full state name)
use.state <- "Tennessee"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.state.plot <- ggplot(agg.cases.state[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.cases.state.plot
```

#### Our counties

```{r echo = F, message = F, warning = F}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "Washington"
use.county <- "Pierce"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.cases.county.plot
```

```{r echo = F, message = F, warning = F}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "California"
use.county <- "Orange"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.cases.county.plot
```

```{r echo = F, message = F, warning = F}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "South Carolina"
use.county <- "Richland"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.cases.county.plot
```

```{r echo = F, message = F, warning = F}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "South Carolina"
use.county <- "York"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.cases.county.plot
```

```{r echo = F, message = F, warning = F}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "Tennessee"
use.county <- "Davidson"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
agg.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total confirmed COVID cases",
       title = "Total confirmed COVID cases",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.cases.county.plot
```

### New confirmed cases {.tabset .tabset-fade}

#### U.S.

```{r echo = F, message = F, warning = F}
agg.cases.US <- state.raw[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.US
agg.cases.US[, total_cases_prev := temp$total_cases[match(agg.cases.US$date - 1, temp$date)]]
agg.cases.US[, total_new_cases := total_cases - total_cases_prev]
agg.cases.US[, total_cases_prev7 := temp$total_cases[match(agg.cases.US$date - 7, temp$date)]]
agg.cases.US[, avg_new_cases7 := (total_cases - total_cases_prev7)/7]

agg.new.cases.US.plot <- ggplot(agg.cases.US[date >= "2020-03-01"]) + 
  geom_bar(stat = "identity", aes(x = date, y = total_new_cases, fill = "Daily figures")) +
  scale_fill_manual("", values=c("Daily figures" = "#999999")) + 
  geom_line(aes(x = date, y = avg_new_cases7, color = "7-day average")) +
  scale_colour_manual("", values=c("7-day average" = "#000000")) + 
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = "United States") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank(),
        legend.position = "top") +
  scale_y_continuous(labels = comma)
agg.new.cases.US.plot
```

#### Our states

```{r echo = F, message = F, warning = F}
use.state <- "Washington"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.state
agg.cases.state[, total_cases_prev := temp$total_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_new_cases := total_cases - total_cases_prev]
agg.cases.state[, total_cases_prev7 := temp$total_cases[match(agg.cases.state$date - 7, temp$date)]]
agg.cases.state[, avg_new_cases7 := (total_cases - total_cases_prev7)/7]

agg.new.cases.state.plot <- ggplot(agg.cases.state[date >= "2020-03-01"]) + 
  geom_bar(stat = "identity", aes(x = date, y = total_new_cases, fill = "Daily figures")) +
  scale_fill_manual("", values=c("Daily figures" = "#999999")) + 
  geom_line(aes(x = date, y = avg_new_cases7, color = "7-day average")) +
  scale_colour_manual("", values=c("7-day average" = "#000000")) + 
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank(),
        legend.position = "top") +
  scale_y_continuous(labels = comma)
agg.new.cases.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "California"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.state
agg.cases.state[, total_cases_prev := temp$total_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_new_cases := total_cases - total_cases_prev]
agg.cases.state[, total_cases_prev7 := temp$total_cases[match(agg.cases.state$date - 7, temp$date)]]
agg.cases.state[, avg_new_cases7 := (total_cases - total_cases_prev7)/7]

agg.new.cases.state.plot <- ggplot(agg.cases.state[date >= "2020-03-01"]) + 
  geom_bar(stat = "identity", aes(x = date, y = total_new_cases, fill = "Daily figures")) +
  scale_fill_manual("", values=c("Daily figures" = "#999999")) + 
  geom_line(aes(x = date, y = avg_new_cases7, color = "7-day average")) +
  scale_colour_manual("", values=c("7-day average" = "#000000")) + 
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank(),
        legend.position = "top") +
  scale_y_continuous(labels = comma)
agg.new.cases.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "South Carolina"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.state
agg.cases.state[, total_cases_prev := temp$total_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_new_cases := total_cases - total_cases_prev]
agg.cases.state[, total_cases_prev7 := temp$total_cases[match(agg.cases.state$date - 7, temp$date)]]
agg.cases.state[, avg_new_cases7 := (total_cases - total_cases_prev7)/7]

agg.new.cases.state.plot <- ggplot(agg.cases.state[date >= "2020-03-01"]) + 
  geom_bar(stat = "identity", aes(x = date, y = total_new_cases, fill = "Daily figures")) +
  scale_fill_manual("", values=c("Daily figures" = "#999999")) + 
  geom_line(aes(x = date, y = avg_new_cases7, color = "7-day average")) +
  scale_colour_manual("", values=c("7-day average" = "#000000")) + 
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank(),
        legend.position = "top") +
  scale_y_continuous(labels = comma)
agg.new.cases.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "Tennessee"
cases.state <- state.raw[state %in% use.state]
agg.cases.state <- cases.state[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.state
agg.cases.state[, total_cases_prev := temp$total_cases[match(agg.cases.state$date - 1, temp$date)]]
agg.cases.state[, total_new_cases := total_cases - total_cases_prev]
agg.cases.state[, total_cases_prev7 := temp$total_cases[match(agg.cases.state$date - 7, temp$date)]]
agg.cases.state[, avg_new_cases7 := (total_cases - total_cases_prev7)/7]

agg.new.cases.state.plot <- ggplot(agg.cases.state[date >= "2020-03-01"]) + 
  geom_bar(stat = "identity", aes(x = date, y = total_new_cases, fill = "Daily figures")) +
  scale_fill_manual("", values=c("Daily figures" = "#999999")) + 
  geom_line(aes(x = date, y = avg_new_cases7, color = "7-day average")) +
  scale_colour_manual("", values=c("7-day average" = "#000000")) + 
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank(),
        legend.position = "top") +
  scale_y_continuous(labels = comma)
agg.new.cases.state.plot
```

#### Our counties

```{r echo = F, message = F, warning = F}
use.state <- "Washington"
use.county <- "Pierce"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.county
agg.cases.county[, total_cases_prev := temp$total_cases[match(agg.cases.county$date - 1, temp$date)]]
agg.cases.county[, total_new_cases := total_cases - total_cases_prev]
agg.new.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_new_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.new.cases.county.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "California"
use.county <- "Orange"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.county
agg.cases.county[, total_cases_prev := temp$total_cases[match(agg.cases.county$date - 1, temp$date)]]
agg.cases.county[, total_new_cases := total_cases - total_cases_prev]
agg.new.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_new_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.new.cases.county.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "South Carolina"
use.county <- "Richland"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.county
agg.cases.county[, total_cases_prev := temp$total_cases[match(agg.cases.county$date - 1, temp$date)]]
agg.cases.county[, total_new_cases := total_cases - total_cases_prev]
agg.new.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_new_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.new.cases.county.plot
```

```{r  echo = F, message = F, warning = F}
use.state <- "South Carolina"
use.county <- "York"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.county
agg.cases.county[, total_cases_prev := temp$total_cases[match(agg.cases.county$date - 1, temp$date)]]
agg.cases.county[, total_new_cases := total_cases - total_cases_prev]
agg.new.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_new_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.new.cases.county.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "Tennessee"
use.county <- "Davidson"
cases.county <- county.raw[state %in% use.state & county %in% use.county]
agg.cases.county <- cases.county[order(date),
                          .(total_cases = sum(cases, na.rm = T)),
                          by = "date"]
temp <- agg.cases.county
agg.cases.county[, total_cases_prev := temp$total_cases[match(agg.cases.county$date - 1, temp$date)]]
agg.cases.county[, total_new_cases := total_cases - total_cases_prev]
agg.new.cases.county.plot <- ggplot(agg.cases.county[date >= "2020-03-01"], aes(x = date, y = total_new_cases)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Confirmed new COVID cases",
       title = "Confirmed new COVID cases by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.new.cases.county.plot
```

### Total deaths {.tabset .tabset-fade}

#### U.S.

```{r echo = F, message = F, warning = F}
agg.deaths.US <- state.raw[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.US.plot <- ggplot(agg.deaths.US[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = "United States") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = comma)
agg.deaths.US.plot
```

#### Our states

```{r echo = F, message = F, warning = F}
# adjust state name to flow through rest of code (use capitalized full state name)
use.state <- "Washington"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- cases.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.state.plot <- ggplot(agg.deaths.state[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.deaths.state.plot
```

```{r echo = F, message = F, warning = F}
# adjust state name to flow through rest of code (use capitalized full state name)
use.state <- "California"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- cases.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.state.plot <- ggplot(agg.deaths.state[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.deaths.state.plot
```

```{r echo = F, message = F, warning = F}
# adjust state name to flow through rest of code (use capitalized full state name)
use.state <- "South Carolina"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- cases.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.state.plot <- ggplot(agg.deaths.state[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.deaths.state.plot
```

```{r echo = F, message = F, warning = F}
# adjust state name to flow through rest of code (use capitalized full state name)
use.state <- "Tennessee"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- cases.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.state.plot <- ggplot(agg.deaths.state[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.deaths.state.plot
```

#### Our counties

```{r echo = F, message = F, warning = F}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "Washington"
use.county <- "Pierce"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.deaths.county.plot
```

```{r echo = F, message = F, warning = F}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "California"
use.county <- "Orange"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.deaths.county.plot
```

```{r echo = F, message = F, warning = F}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "South Carolina"
use.county <- "Richland"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.deaths.county.plot
```

```{r echo = F, message = F, warning = F}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "South Carolina"
use.county <- "York"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.deaths.county.plot
```

```{r echo = F, message = F, warning = F}
# adjust state and county name to flow through rest of code (use capitalized full state name)
use.state <- "Tennessee"
use.county <- "Davidson"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
agg.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "Total COVID-related deaths",
       title = "Total COVID-related deaths",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.deaths.county.plot
```

### New deaths {.tabset .tabset-fade}

#### U.S.

```{r echo = F, message = F, warning = F}
agg.deaths.US <- state.raw[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.US
agg.deaths.US[, total_deaths_prev := temp$total_deaths[match(agg.deaths.US$date - 1, temp$date)]]
agg.deaths.US[, total_new_deaths := total_deaths - total_deaths_prev]
agg.deaths.US[, total_deaths_prev7 := temp$total_deaths[match(agg.deaths.US$date - 7, temp$date)]]
agg.deaths.US[, avg_new_deaths7 := (total_deaths - total_deaths_prev7)/7]

agg.new.deaths.US.plot <- ggplot(agg.deaths.US[date >= "2020-03-01"]) + 
  geom_bar(stat = "identity", aes(x = date, y = total_new_deaths, fill = "Daily figures")) +
  scale_fill_manual("", values=c("Daily figures" = "#999999")) + 
  geom_line(aes(x = date, y = avg_new_deaths7, color = "7-day average")) +
  scale_colour_manual("", values=c("7-day average" = "#000000")) + 
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = "United States") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank(),
        legend.position = "top") +
  scale_y_continuous(labels = comma)
agg.new.deaths.US.plot
```

#### Our states

```{r echo = F, message = F, warning = F}
use.state <- "Washington"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- deaths.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_prev := temp$total_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_new_deaths := total_deaths - total_deaths_prev]
agg.deaths.state[, total_deaths_prev7 := temp$total_deaths[match(agg.deaths.state$date - 7, temp$date)]]
agg.deaths.state[, avg_new_deaths7 := (total_deaths - total_deaths_prev7)/7]

agg.new.deaths.state.plot <- ggplot(agg.deaths.state[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity", aes(x = date, y = total_new_deaths, fill = "Daily figures")) +
  scale_fill_manual("", values=c("Daily figures" = "#999999")) + 
  geom_line(aes(x = date, y = avg_new_deaths7, color = "7-day average")) +
  scale_colour_manual("", values=c("7-day average" = "#000000")) + 
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank(),
        legend.position = "top")
agg.new.deaths.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "California"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- deaths.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_prev := temp$total_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_new_deaths := total_deaths - total_deaths_prev]
agg.deaths.state[, total_deaths_prev7 := temp$total_deaths[match(agg.deaths.state$date - 7, temp$date)]]
agg.deaths.state[, avg_new_deaths7 := (total_deaths - total_deaths_prev7)/7]

agg.new.deaths.state.plot <- ggplot(agg.deaths.state[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity", aes(x = date, y = total_new_deaths, fill = "Daily figures")) +
  scale_fill_manual("", values=c("Daily figures" = "#999999")) + 
  geom_line(aes(x = date, y = avg_new_deaths7, color = "7-day average")) +
  scale_colour_manual("", values=c("7-day average" = "#000000")) + 
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank(),
        legend.position = "top")
agg.new.deaths.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "South Carolina"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- deaths.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_prev := temp$total_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_new_deaths := total_deaths - total_deaths_prev]
agg.deaths.state[, total_deaths_prev7 := temp$total_deaths[match(agg.deaths.state$date - 7, temp$date)]]
agg.deaths.state[, avg_new_deaths7 := (total_deaths - total_deaths_prev7)/7]

agg.new.deaths.state.plot <- ggplot(agg.deaths.state[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity", aes(x = date, y = total_new_deaths, fill = "Daily figures")) +
  scale_fill_manual("", values=c("Daily figures" = "#999999")) + 
  geom_line(aes(x = date, y = avg_new_deaths7, color = "7-day average")) +
  scale_colour_manual("", values=c("7-day average" = "#000000")) + 
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank(),
        legend.position = "top")
agg.new.deaths.state.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "Tennessee"
deaths.state <- state.raw[state %in% use.state]
agg.deaths.state <- deaths.state[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.state
agg.deaths.state[, total_deaths_prev := temp$total_deaths[match(agg.deaths.state$date - 1, temp$date)]]
agg.deaths.state[, total_new_deaths := total_deaths - total_deaths_prev]
agg.deaths.state[, total_deaths_prev7 := temp$total_deaths[match(agg.deaths.state$date - 7, temp$date)]]
agg.deaths.state[, avg_new_deaths7 := (total_deaths - total_deaths_prev7)/7]

agg.new.deaths.state.plot <- ggplot(agg.deaths.state[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity", aes(x = date, y = total_new_deaths, fill = "Daily figures")) +
  scale_fill_manual("", values=c("Daily figures" = "#999999")) + 
  geom_line(aes(x = date, y = avg_new_deaths7, color = "7-day average")) +
  scale_colour_manual("", values=c("7-day average" = "#000000")) + 
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = use.state) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank(),
        legend.position = "top")
agg.new.deaths.state.plot
```

#### Our counties

```{r echo = F, message = F, warning = F}
use.state <- "Washington"
use.county <- "Pierce"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.county
agg.deaths.county[, total_deaths_prev := temp$total_deaths[match(agg.deaths.county$date - 1, temp$date)]]
agg.deaths.county[, total_new_deaths := total_deaths - total_deaths_prev]
agg.new.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.new.deaths.county.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "California"
use.county <- "Orange"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.county
agg.deaths.county[, total_deaths_prev := temp$total_deaths[match(agg.deaths.county$date - 1, temp$date)]]
agg.deaths.county[, total_new_deaths := total_deaths - total_deaths_prev]
agg.new.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.new.deaths.county.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "South Carolina"
use.county <- "Richland"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.county
agg.deaths.county[, total_deaths_prev := temp$total_deaths[match(agg.deaths.county$date - 1, temp$date)]]
agg.deaths.county[, total_new_deaths := total_deaths - total_deaths_prev]
agg.new.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.new.deaths.county.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "South Carolina"
use.county <- "York"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.county
agg.deaths.county[, total_deaths_prev := temp$total_deaths[match(agg.deaths.county$date - 1, temp$date)]]
agg.deaths.county[, total_new_deaths := total_deaths - total_deaths_prev]
agg.new.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.new.deaths.county.plot
```

```{r echo = F, message = F, warning = F}
use.state <- "Tennessee"
use.county <- "Davidson"
deaths.county <- county.raw[state %in% use.state & county %in% use.county]
agg.deaths.county <- deaths.county[order(date),
                          .(total_deaths = sum(deaths, na.rm = T)),
                          by = "date"]
temp <- agg.deaths.county
agg.deaths.county[, total_deaths_prev := temp$total_deaths[match(agg.deaths.county$date - 1, temp$date)]]
agg.deaths.county[, total_new_deaths := total_deaths - total_deaths_prev]
agg.new.deaths.county.plot <- ggplot(agg.deaths.county[date >= "2020-03-01"], aes(x = date, y = total_new_deaths)) + 
  geom_bar(stat = "identity") +
    labs(x = "Date",
       y = "New COVID-related deaths",
       title = "New COVID-related deaths by day",
       subtitle = paste0(use.county, " County, ", use.state)) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
agg.new.deaths.county.plot
```

## Stay-at-home comparisons

* This section is a work in progress. It's exploring what effect stay-at-home orders have on spread. It's inherentely messy because some states have localized orders but not orders for their full state and because states implemented the orders at different times.
  * The first plot shows a rolling 3-day average of new cases per million residents, averaged across 2 groups of states -- those with a state-wide stay-at-home order in effect and those without. The size of the dots reflect the number of states in each group for each given day (so the dots are getting bigger over time for the group with orders, as more states implement those orders).
    * So far, this view doesn't show if these orders are "working" or not. Instead, the biggest takeaway from the current plot is that the states that implemented orders are reacting to having worse spread, which is why the case rate is so much higher at the start for them. As a state decides it has a problem and implements an order, it joins the grouping of states with orders and drives the rate up for that group.
    * Over time (if the policies work), what we'd expect is that the line for the group with orders flattens a bit, but we'll see. It also may become moot if all states issue orders.
  * The second plot is new and is attempting to track the progress normalized for how long each state has had the order. It shows the average of the ratio for each state of the new cases for any given day to the number of new cases on the day the order was enacted. If the orders are working, over time this line should come back down...but it isn't there yet.

```{r echo = F, message = F, warning = F}
state.dt <- state.raw
state.dt[, stay_date := stay_dates$start_date[match(state.raw$state, stay_dates$state)]]
state.dt[, population := stay_dates$population[match(state.raw$state, stay_dates$state)]]
#state.dt[, flgOrder := ifelse(is.na(stay_date), 0, 1)]
state.dt[, flgOrder := ifelse(is.na(stay_date) | stay_date >= date, "No", "Yes")]
#state.dt[, ctDaysFromBaseline := ifelse(flgOrder == 0, as.integer(date - as.Date("2020-03-10")),
#                                         as.integer(date - stay_date))]
#state.dt[, ctDaysFromBaseline := as.integer(date - stay_date)]
temp <- state.dt
temp <- temp[, c("date", "state", "cases")]
setnames(temp, "cases", "cases_prev3")
state.dt[, dtPrev3 := date - 3]
state.dt <- merge(state.raw, temp, all.x = T, by.x = c("state", "dtPrev3"), by.y = c("state", "date"))
state.dt[, casesNewPerMillion := as.integer((cases - cases_prev3)/population * 1000000)]
state.agg.comp <- state.dt[date >= "2020-03-10" & !state %in% "Puerto Rico"]
state.agg.comp <- state.agg.comp[order(date, flgOrder),
                          .(avgNewCases = mean(casesNewPerMillion, na.rm = T),
                            cts = .N),
                           by = c("date", "flgOrder")]
state.agg.comp.plot <- ggplot(state.agg.comp, aes(x = date, y = avgNewCases, colour = as.factor(flgOrder))) +
  geom_point(aes(size = cts)) +
  geom_line(aes(group = flgOrder)) +
    labs(x = "Date",
       y = "New confirmed COVID cases per million residents",
       title = "New COVID cases vs.stay-at-home order",
       subtitle = "Average of rolling 3-day total of new cases per million residents",
       size = "Count of states",
       colour = "Stay-at-home order") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank())
state.agg.comp.plot
```

```{r echo = F, message = F, warning = F}
state.dt[, daysFromStayOrder := as.integer(date - stay_date)]
key.data <- state.dt[daysFromStayOrder == 0]
state.dt[, baselineNewCases := key.data$casesNewPerMillion[match(state.dt$state, key.data$state)]]
state.dt[, ratioToBaseline := casesNewPerMillion/baselineNewCases]
state.stay.comp <- state.dt[!is.na(stay_date) & daysFromStayOrder >= -7 & !state %in% "Puerto Rico"]
state.stay.comp <- state.stay.comp[!is.na(ratioToBaseline),
                                   .(avgBaselineRate = mean(ratioToBaseline, na.rm = T),
                                     cts = .N),
                                   by = c("daysFromStayOrder")]
state.stay.comp.plot <- ggplot(state.stay.comp, aes(x = daysFromStayOrder, y = avgBaselineRate)) +
  geom_line() +
  geom_point(aes(size = cts)) +
    labs(x = "Days from stay-at-home order",
       y = "Ratio of new cases to day order was issued",
       title = "New COVID cases by stay-at-home order timing",
       subtitle = "Comparing new cases to day when order was issued",
       size = "Count of states") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
state.stay.comp.plot
```

